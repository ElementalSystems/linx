var lev={
  0: "02002020922A1B4000000h1G1b40000c042D3000000A1I534000000A5C50000000000",
  1: "01602424522000000000055520000114a41140000555200000031525a000000001500",
  2: "020304057211300000000606113000010646c0000001d5c140000305a1c0000000000",
  3: "0221242671134d1d200b2had400d3c1ffgae1d4215200530000005554000000000000",
  4: "012335355B1E1E1D2000000A1A3D300C3A1FeD400A0AbFeA40000EbFeA40000A0FeA4",
  5: "0135222230022000000003353b30000@aied4000000ia1400000000c5000000000000",
  6: "025201014a1b4a2000000fdfafdc40000fafaa40000a0faa40000a1faa4000000a5b5",
  7: "02210202500b1d20000000000d3B30000D1GbD4c3C3A0GcA3a0Gae1d4E000A0E1E1D4",
  8: "021710180122141130040@b41@e008a8c8c3000400000420010414141140000000000",
  9: "0152040682113000000005012000011419a530000@e41@b0000505f@d@a0000153000",
  10: "0205302080000b2000000c300d30000e000e00000ebe1ea0000000000000000000000",
  11: "0322253030000214113d1d2330040b011jda34000c1jejb54000010jdad000000a0af",
  12: "017620204222300000051715200005040425300001f8a1f130000318a540000000000",
  13: "011703244515251240040A2JcA3B340HaIaIaD440IaJaJaA410818cE20000003000C5",
  14: "022709129000012211351@a54@e544033535053408f7a118050108b14150055240000",
  15: "022003036D1E1A3a200E023D0b0d3E09ajaGcd4E030jakdD3A0E1GbkdE00000c0C0B0",
  16: "016530285000000000031418b413412517c1400109a544210225053219b00558b4154",
  17: "015802046B300b30000HaA3e0C300A2HfGcDc00A0Ha00d3D30000D5GcD400000000c5",
  18: "021110105b1d21212000051ia@e25c1gcd44053003000105400000000000000000000",
  19: "030400241A200235124MbFd4040C3MbF3Jbl0E0MbF3518bk1A0F350401500A0B41f34",
  20: "03502020932a1e1e1a3D1Lakaa1d4C0kakaB2b500kakaA3D311LbkaMbD40025c5C0B5",
  21: "13040606800005134000000OC4113235154Q3OA105451QA402141QA51630021416454",
  22: "1187192150000332300000040400051525080135000QDRD8300555440150000001024",
  23: "11800000100120023000030424000515211OD135021PA808300555440150000001024",
  24: "1274030060000000000005152000031Q02353000011P57C000011PAP0140000PA9014",
  25: "115530346000023000000004000005141OAPA345051QA4053001511PD540000001500",
  26: "0106002450000A2A1B400B2B0QAD300QBQCQCF300B0M1QEQC0000C1QAE000000000B0",
  27: "015720184B300C30000D0A2E00000A1QbPB0000D1M0P0PAA3B0D0PBM1D40000A5A5B5",
  28: "11032124800b1aD00000000d0c5000000d0a200e1d1eAe4e3e0a2d0e5e400a5a50000",
  29: "1118080860051240000004023000051QA4000001041NA130000004015000000300000",
  30: "111c12182000000000000511300000020SD13000031SCQA000000506C140000001500",
  31: "110703055b200a2b30000d2e0fDa30000d2gDf3000000dAa50000c1g4a40000000000",
  32: "110b0200300b1a300000000d00000a1d1dAe20000d2eAc4e30000a5e5e40000000000",
  33: "11050404800h3e2000000d0a2h50000fDe4gA0000h200d0e30000e5h0c00000000000",
  34: "1112303060032b300000051nA24000040iA42000050gDe3530000nAa5400000c05554",
  35: "11142429400a2b1e20000gEh1a3e300c0gFe4d000e1e4e5e400g000000000a0a40000",
  36: "1104202230032c2b300e1e28DgD23e021mDmC5400e5e415e300000000000000000000",
  37: "014801275D1D2514113P0JBJFB420PAJCJACA00QAQA40PA00Q0QAI0E1A4B000311400",
  38: "123b10103C3B3231200D0A0qBPB1400E240qC140000qBD45A00003055540000000000",
  39: "120a06069214113A20012D1r0FAD3qCqAr0D2A5E08CR052B5C09A90OAOA0000153515",
  40: "130c1818100e1e20000c2e000h50000eBdAe40000h200e3000000e5e4000000000000",
  41: "123b201050000b3a2001232d0gDgC806AoAg4gC408C40c50010542000000000000000",
  42: "120a2222621522351240000PAPA130000PAPAPA11PAPAPAPA31PAPA14000000000000",
  43: "120928284000023b30000mAmAmA0000mAmAmA000000mAmA000000mAmAmA0000c00030",
  44: "119630057c2b3000000B1TAA3000000TATAB30000TATATA000000TAA5000000C00000",
  45: "110c0302700B2C2000000UAUAD30000UAUATA00a1d1TBTE0000h1e4UBe3000000c0a5",
  46: "110a002440000000000c2b3512400a1gDnEa3C3D1T0rBT0qAB0a0nDe4A50000300000",
  47: "114702056A200000000H0E5ABE1A3A0E1AEE5H30000ABD2A50000E0H2D30000A0E1AE",
  48: "112c12125D1H1D20000D09A6AD32331r19Ar2400000D5GB8A0000A1GBA4000000A500",
  49: "12193432300b1a3000000a2a0a30000iBiBiB0000iAiBa50000c00000000000000000",
  50: "112831315230000000040a2a1a30040iBiBiB0050iAiBa5b531nA41520000c0554114",
  51: "130b00005e1d1e20000d0e1e2d200gAd000j0j0gAdBe2d0d0e0eAe5dBgE00a5e5e4a5",
  52: "117a18189000000000000b223000000oCpA130000c1pA800000003015000000000000"
};


var lv_id=0;
var lv_menu_start=1;

function levTime(id)
{
  return Number(lev[id].substring(1,3));
}

function exp(com,tm) {
  if (!com) return "Never Attempted";
  var t="Saved <b>"+Number(com).toFixed(0)+"%</b> of the packets ";
  if (com==100)
    t+=" in "+Number(tm).toFixed(1)+"s";
  return t;
}

function expG(com,tm) {
  var res="";
  var tt=levTime(lv_id);
  res+="Save 50% for 1 Star";
  if (com>=50) res+=" <b>Complete</b>";
  res+="<br>Save 100% for 2 Stars";
  if (com>=100) res+=" <b>Complete</b>";
  res+="<br>Save 100% in "+tt+"s for 3 Stars";
  if ((com>=100)&&(tm<=tt)) res+=" <b>Complete</b>";
  return res;
}

function decLev(id)
{
  var d=document.getElementById(id);
  d.style.color=t_thm.textc;
  t_thm.bot(d,[]);//no links just background

}

function level(lv) {
  lv_id=lv;
  killGrid(document.getElementById('main'));
  thm(lev[lv_id],document.getElementById('top'));
  //set up start thing
  document.getElementById('dp').classList.toggle('st',true);
  document.getElementById('dp').classList.toggle('ed',false);
  document.getElementById('dp').classList.toggle('fst',false);
  document.getElementById('menu').classList.toggle('act',false);
  document.getElementById('shr').classList.toggle('act',false);
  document.getElementById('levctl').classList.toggle('act',false);

  document.getElementById('dpl').innerHTML=lv;
  checkStars(document.getElementById('dpst'),lv);
  decLev('dpl');
  document.getElementById('dpr').innerHTML="<i>Best:</i> "+exp(localStorage.getItem("com_"+lv_id),localStorage.getItem("tm_"+lv_id));
  document.getElementById('dpt').innerHTML="<i>Goals:</i> "+expG(localStorage.getItem("com_"+lv_id),localStorage.getItem("tm_"+lv_id));
  document.getElementById('main').innerHTML='';
  document.getElementById('ti').classList.toggle('act',false);
  document.getElementById('ti2').classList.toggle('act',false);
  if (lv_id) document.getElementById('ti3').classList.toggle('act',true);

  ae.click();
}

function startNext()
{
  fullScreen();
  level(lv_id+1);
}

function start() {
  document.getElementById('dp').classList.toggle('st',false);
  document.getElementById('dp').classList.toggle('ed',false);
  document.getElementById('menu').classList.toggle('act',false);
  document.getElementById('shr').classList.toggle('act',false);
  document.getElementById('levctl').classList.toggle('act',false);

  killGrid(document.getElementById('main'));
  setTimeout(
    function(){  buildGrid(document.getElementById('main'), lev[lv_id],1);
    if (lv_id) {
      document.getElementById('ti').classList.toggle('act',true);
      document.getElementById('ti2').classList.toggle('act',true);
    }
    document.getElementById('stut').classList.toggle('show',lv_id==2);
    document.getElementById('ti3').classList.toggle('act',true);
  },1000);
  ae.levstart();
}

function menu() {
  document.getElementById('ti').classList.toggle('act',false);
  document.getElementById('ti2').classList.toggle('act',false);
  document.getElementById('ti3').classList.toggle('act',false);
  document.getElementById('shr').classList.toggle('act',false);
  document.getElementById('intro').classList.toggle('kill',true);
  document.getElementById('levctl').classList.toggle('act',true);

  document.getElementById('dp').classList.toggle('st',false);
  document.getElementById('dp').classList.toggle('ed',false);
  document.getElementById('dp').classList.toggle('fst',false);
  //set up starts
  var menu=document.getElementById('menu');
  var its=menu.childNodes;
  for (var i=0;i<20;i+=1)
    checkStars(its[i],i+lv_menu_start);
  menu.classList.toggle('act',true);
  killGrid(document.getElementById('main'));
  ae.click();
  fullScreen();
}

function end(com,tm)
{
  document.getElementById('ti2').classList.toggle('act',false);
  document.getElementById('ti3').classList.toggle('act',false);
  if (lv_id) document.getElementById('shr').classList.toggle('act',true);
  if (optionalFeedbackPosition) optionalFeedbackPosition(lv_id)

  ae.levend();
  //update high scores
  var oc=localStorage.getItem("com_"+lv_id);
  if (!oc) oc=0;
  localStorage.setItem("com_"+lv_id,Math.max(com,oc));
  var otm=localStorage.getItem("tm_"+lv_id);
  if (!otm) otm=999;
  localStorage.setItem("tm_"+lv_id,Math.min(tm,otm));

  checkStars(document.getElementById('dpst'),lv_id);

  if (lv_id) { //if we are not on level 0
    document.getElementById('dpr').innerHTML="<i>Result:</i> "+exp(com,tm);
    document.getElementById('dpt').innerHTML="<i>Goals:</i> "+expG(com,tm);
    document.getElementById('dp').classList.toggle('ed',true);
  } else {
    document.getElementById('dpr').innerHTML="The Lost Packets";
    document.getElementById('dpt').innerHTML="<i>... an abstract puzzle game in 13kb by elementalsystems ...</i>";
    document.getElementById('dp').classList.toggle('fst',true);
  }
}

function addStrs(el,c)
{
  if (!el) return;
  for (var i=0;i<c;i+=1) {
    var d=document.createElement('div');
    d.classList.add('str');
    mkStr(d);
    el.appendChild(d);
  }
}

function checkStars(el,lev)
{
  var c=Number(localStorage.getItem("com_"+lev));
  var t=Number(localStorage.getItem("tm_"+lev));
  var tar=0;
  if (c>=50) tar=1;
  if (c>=100){
    tar=2;
    if (t<=levTime(lev)) tar=3
  }
  var chd = el.childNodes;
  for (var i = 0; i < 3; i++)
     if (chd[i]) chd[i].classList.toggle('off',((i+1)>tar));
}

function mkLvlMenu()
{
  function itm(i) {
    var e=document.createElement('div');
    var ei=document.createElement('div');
    ei.innerHTML=i;
    if (!lev[i]) return e;
    thm(lev[i],e);
    t_thm.bot(ei,[]);
    addStrs(e,3);
    e.appendChild(ei);
    e.onclick=function() { level(i); }
    return e;
  }
  var m=document.getElementById('menu');
  m.innerHTML='';
  for (var i=lv_menu_start;i<lv_menu_start+20;i+=1)
    m.appendChild(itm(i));
}

function setSound(on) {
  ae.click();
  audio_mute=!on;
  ae.click();
  document.getElementById('soundon').classList.toggle('act',audio_mute)
  document.getElementById('soundoff').classList.toggle('act',!audio_mute)
}

function changeLevels(dir)
{
  ae.click();
  document.getElementById('menu').classList.toggle('act',false);
  lv_menu_start+=dir*20;
  if (lv_menu_start<1) lv_menu_start=1;
  if (lv_menu_start>41) lv_menu_start=41;
  setTimeout(function() {
    mkLvlMenu();
    menu();
    ae.click();
  },400);
}

function clearForm()
{
  document.getElementById('formholder').classList.toggle('act',false);
}
